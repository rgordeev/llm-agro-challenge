#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Справочные данные для валидации сельскохозяйственных данных.
"""

import difflib
import re
from typing import Optional

# Список допустимых операций
VALID_OPERATIONS = [
    "1-я междурядная культивация",
    "2-я междурядная культивация",
    "Боронование",
    "Боронование довсходовое",
    "Боронование послевсходовое",
    "Боронование легкое",
    "Боронование среднее",
    "Боронование тяжелое",
    "Внесение минеральных удобрений",
    "Выравнивание зяби",
    "2-е Выравнивание зяби",
    "Гербицидная обработка",
    "1 Гербицидная обработка",
    "2 Гербицидная обработка",
    "3 Гербицидная обработка",
    "4 Гербицидная обработка",
    "Дискование",
    "Дискование 2-е",
    "Инсектицидная обработка",
    "Культивация",
    "Пахота",
    "Пахота зяби",
    "Подкормка",
    "Предпосевная культивация",
    "Прикатывание посевов",
    "Сев",
    "Сплошная культивация",
    "Уборка",
    "Функицидная обработка",
    "Чизелевание"
]

# Структура подразделений
DIVISIONS = {
    "АОР": {
        "Кавказ": [18, 19],
        "Север": [3, 7, 10, 20],
        "Центр": [1, 4, 5, 6, 9],
        "Юг": [11, 12, 16, 17]
    },
    "ТСК": [],
    "АО Кропоткинское": [],
    "Восход": [],
    "Колхоз Прогресс": [],
    "Мир": [],
    "СП Коломейцево": []
}

# Список допустимых культур
VALID_CROPS = [
    "Озимая пшеница",
    "Озимый ячмень",
    "Яровой ячмень",
    "Овес",
    "Горох",
    "Подсолнечник",
    "Кукуруза",
    "Соя",
    "Рапс",
    "Горчица",
    "Лен",
    "Многолетние травы",
    "Многолетние травы текущего года",
    "Многолетние травы прошлых лет",
    "Однолетние травы",
    "Люцерна",
    "Эспарцет",
    "Донник",
    "Клевер",
    "Тимофеевка",
    "Райграс",
    "Овсяница",
    "Кострец",
    "Житняк",
    "Пырей",
    "Суданская трава",
    "Сорго",
    "Чумиза",
    "Просо",
    "Гречиха",
    "Чечевица",
    "Нут",
    "Люпин",
    "Вика",
    "Рожь",
    "Тритикале",
    "Полба",
    "Пшеница твердая",
    "Пшеница мягкая",
    "Ячмень пивоваренный",
    "Ячмень фуражный",
    "Овес фуражный",
    "Овес продовольственный",
    "Горох продовольственный",
    "Горох кормовой",
    "Подсолнечник масличный",
    "Подсолнечник кондитерский",
    "Кукуруза на зерно",
    "Кукуруза на силос",
    "Соя продовольственная",
    "Соя кормовая",
    "Рапс озимый",
    "Рапс яровой",
    "Горчица белая",
    "Горчица сарептская",
    "Лен масличный",
    "Лен долгунец"
]

# Словарь сокращений
ABBREVIATIONS = {
    "мн тр": "Многолетние травы",
    "оз пш": "Озимая пшеница",
    "оз яч": "Озимый ячмень",
    "яр яч": "Яровой ячмень",
    "подс": "Подсолнечник",
    "кук": "Кукуруза",
    "горох": "Горох",
    "овес": "Овес",
    "соя": "Соя",
    "рапс": "Рапс",
    "горч": "Горчица",
    "лен": "Лен",
    "одн тр": "Однолетние травы",
    "люц": "Люцерна",
    "эсп": "Эспарцет",
    "дон": "Донник",
    "клев": "Клевер",
    "тим": "Тимофеевка",
    "райг": "Райграс",
    "овсян": "Овсяница",
    "костр": "Кострец",
    "жит": "Житняк",
    "пыр": "Пырей",
    "суд": "Суданская трава",
    "сорг": "Сорго",
    "чум": "Чумиза",
    "прос": "Просо",
    "греч": "Гречиха",
    "чеч": "Чечевица",
    "нут": "Нут",
    "люп": "Люпин",
    "вика": "Вика",
    "рожь": "Рожь",
    "трит": "Тритикале",
    "полба": "Полба"
}

# Словарь исправлений для операций
OPERATION_CORRECTIONS = {
    "пахота зяби": "Пахота зяби",
    "пахота": "Пахота",
    "борон": "Боронование",
    "сев": "Сев",
    "уборка": "Уборка",
    "культивац": "Культивация",
    "дискован": "Дискование",
    "внесение": "Внесение минеральных удобрений",
    "подкормка": "Подкормка"
}

# Словарь исправлений для культур
CROP_CORRECTIONS = {
    "пшеница": "Озимая пшеница",
    "ячмень": "Яровой ячмень",
    "травы": "Многолетние травы",
    "подсол": "Подсолнечник",
    "кукур": "Кукуруза"
}

# Словарь сокращений культур
CROP_ABBREVIATIONS = {
    "мн тр": "Многолетние травы",
    "мн.тр": "Многолетние травы",
    "мн. тр": "Многолетние травы",
    "оз пш": "Озимая пшеница",
    "оз.пш": "Озимая пшеница",
    "оз. пш": "Озимая пшеница",
    "подсолн": "Подсолнечник",
    "кукур": "Кукуруза",
    "яр яч": "Яровой ячмень",
    "яр.яч": "Яровой ячмень"
}

def get_division_from_department(department_number: int) -> str:
    """
    Получение подразделения по номеру отдела.
    
    Args:
        department_number (int): Номер отдела
        
    Returns:
        str: Название подразделения или None, если отдел не найден
    """
    for division, regions in DIVISIONS.items():
        if not regions:  # Для подразделений без регионов
            continue
        for region, departments in regions.items():
            if department_number in departments:
                return division
    return None

def get_production_unit_from_department(department_number: int) -> str:
    """
    Получение производственного участка по номеру отдела.
    
    Args:
        department_number (int): Номер отдела
        
    Returns:
        str: Название производственного участка или None, если отдел не найден
    """
    for division, regions in DIVISIONS.items():
        if not regions:  # Для подразделений без регионов
            continue
        for region, departments in regions.items():
            if department_number in departments:
                return region
    return None

def correct_operation(operation: str) -> str:
    """
    Корректирует название операции, используя нечеткое сравнение.
    
    Args:
        operation (str): Исходное название операции
        
    Returns:
        str: Исправленное название операции
    """
    if not operation:
        return ""
        
    # Очистка и приведение к нижнему регистру
    operation = operation.lower().strip()
    
    # Удаляем все после "под" или "по", так как это обычно относится к культуре или подразделению
    operation = re.split(r'\s+(?:под|по)\s+', operation)[0].strip()
    
    # Проверяем точное совпадение
    if operation in [op.lower() for op in VALID_OPERATIONS]:
        return VALID_OPERATIONS[[op.lower() for op in VALID_OPERATIONS].index(operation)]
    
    # Проверяем по словарю коррекций
    for key, value in OPERATION_CORRECTIONS.items():
        if key in operation:
            return value
    
    # Используем нечеткое сравнение для остальных операций
    matches = difflib.get_close_matches(operation, [op.lower() for op in VALID_OPERATIONS], n=1, cutoff=0.8)
    if matches:
        return VALID_OPERATIONS[[op.lower() for op in VALID_OPERATIONS].index(matches[0])]
    
    return operation

def correct_crop(crop: Optional[str]) -> Optional[str]:
    """
    Корректирует название культуры.
    
    Args:
        crop (Optional[str]): Исходное название культуры
        
    Returns:
        Optional[str]: Исправленное название культуры
    """
    if not crop:
        return None
        
    # Очистка и приведение к нижнему регистру
    crop = crop.lower().strip()
    
    # Проверка на сокращения
    for abbr, full_name in CROP_ABBREVIATIONS.items():
        if abbr in crop:
            return full_name
            
    # Проверка точного совпадения
    if crop in [c.lower() for c in VALID_CROPS]:
        return VALID_CROPS[[c.lower() for c in VALID_CROPS].index(crop)]
        
    # Нечеткое сравнение
    matches = difflib.get_close_matches(crop, [c.lower() for c in VALID_CROPS], n=1, cutoff=0.8)
    if matches:
        return VALID_CROPS[[c.lower() for c in VALID_CROPS].index(matches[0])]
        
    return None

def expand_abbreviation(abbr: str) -> str:
    """
    Расшифровка сокращения.
    
    Args:
        abbr (str): Сокращение
        
    Returns:
        str: Полное название или исходное сокращение, если не найдено
    """
    return ABBREVIATIONS.get(abbr.lower(), abbr) 